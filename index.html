<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presensi Webinar MNC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .dropdown-animate { animation: slideDown 0.2s ease-out; }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen flex items-center justify-center p-4">

    <div id="main-container" class="max-w-md w-full bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border border-white/20 my-8">
        <!-- Header -->
        <div class="bg-blue-700 p-8 text-white text-center">
            <h1 class="text-xl font-bold uppercase tracking-wider">Daftar Hadir</h1>
            <p class="text-lg font-semibold mt-2 leading-tight">Webinar Game Edukasi Matematika</p>
            <p class="text-blue-200 text-sm mt-1">Matematika Nusantara Cilacap</p>
        </div>

        <!-- Form Body -->
        <div id="form-body" class="p-8">
            <form id="attendanceForm" class="space-y-5">
                
                <!-- 1. Pilih Nama -->
                <div class="space-y-2 relative">
                    <label class="text-sm font-semibold text-slate-700 block">Pilih Nama</label>
                    <div id="nameTrigger" class="bg-slate-50 border border-slate-300 rounded-lg px-4 py-3 cursor-pointer flex justify-between items-center hover:bg-white transition-all">
                        <span id="selectedNameText" class="text-slate-400 text-sm">Memuat nama...</span>
                        <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                    </div>
                    <div id="nameMenu" class="hidden absolute z-30 w-full mt-1 bg-white border border-slate-300 rounded-xl shadow-xl overflow-hidden dropdown-animate">
                        <div class="p-2 bg-slate-100 border-b">
                            <input type="text" id="nameSearch" class="w-full border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Cari nama...">
                        </div>
                        <div id="nameList" class="max-h-48 overflow-y-auto custom-scroll"></div>
                    </div>
                </div>

                <!-- 2. Instansi (Posisinya di atas Rangkuman) -->
                <div class="space-y-2 relative">
                    <label class="text-sm font-semibold text-slate-700 block">Instansi</label>
                    <div id="instansiTrigger" class="bg-slate-50 border border-slate-300 rounded-lg px-4 py-3 cursor-pointer flex justify-between items-center hover:bg-white transition-all">
                        <span id="selectedInstansiText" class="text-slate-400 text-sm">Pilih Instansi...</span>
                        <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                    </div>
                    <div id="instansiMenu" class="hidden absolute z-20 w-full mt-1 bg-white border border-slate-300 rounded-xl shadow-xl overflow-hidden dropdown-animate">
                        <div class="p-2 bg-slate-100 border-b">
                            <input type="text" id="instansiSearch" class="w-full border border-slate-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Cari instansi...">
                        </div>
                        <div id="instansiList" class="max-h-48 overflow-y-auto custom-scroll"></div>
                    </div>
                </div>

                <!-- 3. Rangkuman Materi -->
                <div class="space-y-2">
                    <label class="text-sm font-semibold text-slate-700 block">Rangkuman Materi</label>
                    <textarea id="rangkuman" required rows="3" class="w-full bg-slate-50 border border-slate-300 rounded-lg px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="Tuliskan poin penting materi..."></textarea>
                </div>

                <!-- 4. Kesan -->
                <div class="space-y-2">
                    <label class="text-sm font-semibold text-slate-700 block">Kesan</label>
                    <textarea id="kesan" required rows="2" class="w-full bg-slate-50 border border-slate-300 rounded-lg px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="Apa kesan Anda mengikuti webinar ini?"></textarea>
                </div>

                <!-- 5. Pesan -->
                <div class="space-y-2">
                    <label class="text-sm font-semibold text-slate-700 block">Pesan</label>
                    <textarea id="pesan" required rows="2" class="w-full bg-slate-50 border border-slate-300 rounded-lg px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="Sampaikan pesan untuk panitia..."></textarea>
                </div>

                <!-- 6. Saran -->
                <div class="space-y-2">
                    <label class="text-sm font-semibold text-slate-700 block">Saran</label>
                    <textarea id="saran" required rows="2" class="w-full bg-slate-50 border border-slate-300 rounded-lg px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="Saran untuk webinar mendatang..."></textarea>
                </div>

                <!-- Tombol Kirim -->
                <button type="submit" id="submitBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95 flex items-center justify-center">
                    Kirim Daftar Hadir
                </button>

            </form>
        </div>

        <div class="pb-6 text-center text-[10px] text-slate-400 uppercase tracking-widest">MNC Â© 2026</div>
    </div>

    <!-- Overlay untuk menutup dropdown jika klik di luar -->
    <div id="overlay" class="fixed inset-0 z-10 hidden bg-black/5"></div>

    <script>
        // MASUKKAN URL WEB APP GOOGLE SCRIPT ANDA DI SINI
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw8RU8DwFfPjFlUiusFKPIJzRqwDCRS5DAub5QU-7RQPkvGE_aIK2VKA-spTnhJVGZR/exec';
        
        // URL Data Nama dan Instansi
        const DATA_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQmBw7t7CYNsi1abmv4Ed1Qo82x8dr9xfaRmpBk9pwyCakEuSxQFG76RxYLXZLEmtBDswPvF6OOw3LR/pub?gid=522171751&single=true&output=csv';

        let dataNama = [];
        let dataInstansi = [];
        let selectedName = "";
        let selectedInstansi = "";

        const nameTrigger = document.getElementById('nameTrigger');
        const nameMenu = document.getElementById('nameMenu');
        const nameList = document.getElementById('nameList');
        const nameSearch = document.getElementById('nameSearch');
        const selectedNameText = document.getElementById('selectedNameText');

        const instansiTrigger = document.getElementById('instansiTrigger');
        const instansiMenu = document.getElementById('instansiMenu');
        const instansiList = document.getElementById('instansiList');
        const instansiSearch = document.getElementById('instansiSearch');
        const selectedInstansiText = document.getElementById('selectedInstansiText');

        const overlay = document.getElementById('overlay');

        async function initData() {
            try {
                const res = await fetch(DATA_URL + '&cache=' + Date.now());
                const csv = await res.text();
                const lines = csv.split(/\r?\n/);
                
                let rawNames = [];
                let rawInstansi = [];

                lines.forEach((line, index) => {
                    if (index === 0) return; // Skip Header
                    const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    
                    let n = cols[1] ? cols[1].replace(/"/g, '').trim() : "";
                    let i = cols[3] ? cols[3].replace(/"/g, '').trim() : "";
                    
                    if (n) rawNames.push(n);
                    if (i) rawInstansi.push(i);
                });

                // Set unik agar instansi tidak ganda
                dataNama = [...new Set(rawNames)].sort();
                dataInstansi = [...new Set(rawInstansi)].sort();

                renderList(nameList, dataNama, 'name');
                renderList(instansiList, dataInstansi, 'instansi');
                
                selectedNameText.innerText = "Pilih Nama Anda...";
                selectedInstansiText.innerText = "Pilih Instansi...";
            } catch (e) {
                selectedNameText.innerText = "Gagal memuat data";
            }
        }

        function renderList(container, data, type) {
            container.innerHTML = data.length > 0 
                ? data.map(item => `<div class="item px-4 py-3 text-sm text-slate-700 hover:bg-blue-50 cursor-pointer border-b border-slate-50 last:border-none">${item}</div>`).join('')
                : `<div class="p-4 text-center text-slate-400 text-sm italic">Data tidak ditemukan</div>`;
            
            container.querySelectorAll('.item').forEach(el => {
                el.onclick = () => {
                    if(type === 'name') {
                        selectedName = el.innerText;
                        selectedNameText.innerText = selectedName;
                        selectedNameText.classList.replace('text-slate-400', 'text-slate-900');
                    } else {
                        selectedInstansi = el.innerText;
                        selectedInstansiText.innerText = selectedInstansi;
                        selectedInstansiText.classList.replace('text-slate-400', 'text-slate-900');
                    }
                    closeAll();
                };
            });
        }

        function closeAll() {
            nameMenu.classList.add('hidden');
            instansiMenu.classList.add('hidden');
            overlay.classList.add('hidden');
        }

        nameTrigger.onclick = () => { closeAll(); nameMenu.classList.remove('hidden'); overlay.classList.remove('hidden'); nameSearch.focus(); };
        instansiTrigger.onclick = () => { closeAll(); instansiMenu.classList.remove('hidden'); overlay.classList.remove('hidden'); instansiSearch.focus(); };
        overlay.onclick = closeAll;

        nameSearch.oninput = (e) => {
            const val = e.target.value.toLowerCase();
            renderList(nameList, dataNama.filter(x => x.toLowerCase().includes(val)), 'name');
        };

        instansiSearch.oninput = (e) => {
            const val = e.target.value.toLowerCase();
            renderList(instansiList, dataInstansi.filter(x => x.toLowerCase().includes(val)), 'instansi');
        };

        document.getElementById('attendanceForm').onsubmit = async (e) => {
            e.preventDefault();
            if(!selectedName || !selectedInstansi) {
                alert("Silakan pilih Nama dan Instansi!");
                return;
            }

            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerText = "Mengirim...";

            const params = new URLSearchParams();
            params.append('Nama', selectedName);
            params.append('Instansi', selectedInstansi);
            params.append('Rangkuman', document.getElementById('rangkuman').value);
            params.append('Kesan', document.getElementById('kesan').value);
            params.append('Pesan', document.getElementById('pesan').value);
            params.append('Saran', document.getElementById('saran').value);

            try {
                // Gunakan mode no-cors untuk kirim data ke Google Apps Script
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: params.toString(),
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
                });

                document.getElementById('main-container').innerHTML = `
                    <div class="p-12 text-center">
                        <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                        </div>
                        <h2 class="text-xl font-bold text-slate-800">Berhasil!</h2>
                        <p class="text-slate-500 mt-2 text-sm">Terima kasih, presensi Anda telah tercatat.</p>
                        <button onclick="location.reload()" class="mt-8 w-full py-4 bg-blue-600 text-white rounded-xl font-bold">Kembali</button>
                    </div>`;
            } catch (err) {
                alert("Terjadi kesalahan pengiriman. Pastikan SCRIPT_URL sudah benar.");
                btn.disabled = false;
                btn.innerText = "Kirim Daftar Hadir";
            }
        };

        window.onload = initData;
    </script>
</body>
</html>
